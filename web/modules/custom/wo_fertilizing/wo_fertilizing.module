<?php

use Drupal\Core\Entity\EntityInterface;
use Drupal\config_pages\ConfigPagesLoaderInterface;
use Drupal\eck\EckEntityInterface;
use Drupal\Core\Datetime\DrupalDateTime;

/**
 * Implements hook_entity_presave().
 */
function wo_fertilizing_entity_presave(EntityInterface $entity) {
    // Initialize $grand_total at the start.
    $grand_total = 0;
    $fertilizingRate = 0;
    $chemical_subtotal = 0;
    $spreader_subtotal = 0;
    $labor_subtotal = 0;
    $trucks = 0;
    $totalTrip = 0;
    $lawnSqFt = 0;

    // Check if it's a Work Order entity of the 'Fertilizing' bundle.
    if ($entity->getEntityTypeId() === 'work_order' && $entity->bundle() === 'fertilizing') {

        // Check if the Work Order is marked as 'Complete'.
        $statusTermId = $entity->get('field_status')->target_id ?? 0;
        if ($statusTermId != 1097) {
            //If the Work Order is not 'Complete', exit the function early to avoid performing further calculations.
            return;
        }
        
        // The Work Order is 'Complete'; you can now proceed with further calculations.
        // Initialize variables to ensure they're defined before use.

        $config_pages_loader = \Drupal::service('config_pages.loader');
        $business_settings = $config_pages_loader->load('business_setting');
        
        if ($business_settings) {
            // Fetch the configured minimums and fees.
            $fertilizerMinimum = $business_settings->get('field_fertilizing_minimum')->value;
            $fertilizer6k20k = $business_settings->get('field_fetilizing_6k_20k_per_ft')->value;
            $fertilizer20k80k = $business_settings->get('field_fetilize_20k_80k_per_ft')->value;
            $fertilizer80kPlus = $business_settings->get('field_fetilize_20k_80k_per_ft')->value;

            $equipmentFeee = $business_settings->get('field_spreader_charge')->value;

            $hourlyRate = $business_settings->get('field_spray_crew_labor')->value;
            
            // Get values from functions
            $poundsTotalUsed = get_pounds_used_for_fertilizing($entity->id()); // Total poounds of all fertilizers entered.
            $fertilizerTotalCosts = get_costs_for_fertilizing($entity->id()); // Total costs of all fertilizers entered.
            $fertilizerChemicalTotalCosts = get_costs_for_fertilizing_chemicals($entity->id()); // Total costs of all fertilizing chemicals entered.
            $timeSpent = get_hours_for_fertilizing($entity->id()); // Total hours of all men that clocked in.

            // There will always only be 1 truck for fertilizing
            // $trucks = $entity->get('field_trucks')->value;

            // Calculate Labor.  Total time spent is calculated within wo_sign_off.module
            $totalTime = $entity->get('field_total_time')->value;

            // First, check if field_current_turf_sq_footage has a value on the work order
            if (!$entity->get('field_current_turf_sq_footage')->isEmpty()) {
                $lawnSqFt = $entity->get('field_current_turf_sq_footage')->value;
            } else {
                // If field_current_turf_sq_footage is empty, get the property ID from the Work Order
                $propertyId = $entity->get('field_property')->target_id;
                
                if ($propertyId) {
                    // Load all 'property_landscape_details' entities where field_property matches our property ID
                    // and ensure the bundle is 'current'
                    $landscapeDetailsEntities = \Drupal::entityTypeManager()->getStorage('property_landscape_details')->loadByProperties([
                        'type' => 'current',
                        'field_property' => $propertyId,
                    ]);

                    if (!empty($landscapeDetailsEntities)) {
                        // Since there might be multiple landscape detail entities, we'll use the first one for simplicity
                        $landscapeDetailsEntity = reset($landscapeDetailsEntities);
                        
                        // Fetch the lawn size from the landscape details entity
                        $lawnSqFt = $landscapeDetailsEntity->get('field_turf_sq_footage')->value ?? 0;

                        // Set the Work Order Lawn Sq Ft to fetched amount
                        $entity->set('field_current_turf_sq_footage', $lawnSqFt);

                    } else {
                        // Handle case where no landscape details entities were found for this property
                        \Drupal::logger('wo_fertilizing')->error('No landscape details found for property ID @propertyId with bundle "current"', ['@propertyId' => $propertyId]);
                    }
                }
            }

            // Now use $lawnSqFt in your calculations, whether it came from work order or property
            if ($lawnSqFt > 0) {
                if ($lawnSqFt <= 6000) {
                    $fertilizingRate = $fertilizerMinimum;
                } elseif ($lawnSqFt <= 20000) {
                    $fertSqFt = $lawnSqFt - 6000;
                    $fert6kPlus = $fertSqFt * $fertilizer6k20k;
                    $fertilizingRate = $fertilizerMinimum + $fert6kPlus;
                } elseif ($lawnSqFt <= 80000) {
                    $fertSqFt = $lawnSqFt - 20000;
                    $fert6kPlus = 14000 * $fertilizer6k20k;
                    $fert20kPlus = $fertSqFt * $fertilizer20k80k;
                    $fertilizingRate = $fertilizerMinimum + $fert6kPlus + $fert20kPlus;
                } else {
                    $fertSqFt = $lawnSqFt - 80000;
                    $fert80kPlus = $fertSqFt * $fertilizer80kPlus;
                    $fertilizingRate = $fertilizerMinimum + $fert80kPlus;
                }
            } else {
                // Handle case where $lawnSqFt is still 0 (neither source provided a value)
                \Drupal::logger('wo_fertilizing')->warning('No turf square footage found for work order ID @workOrderId', ['@workOrderId' => $entity->id()]);
            }

            // Set the Work Order Fertilizing Rate to calculated amount.
            $entity->set('field_task_rate', $fertilizingRate);
        
            // Fertilizer Spreader Fee (Using ATV Total Field in Work Order)
            $hoursPerBlock = 4; // Define this before using it in calculations.
            $blocksUsed = ceil($timeSpent / $hoursPerBlock);
            $spreader_subtotal = $blocksUsed * $equipmentFeee;
            $entity->set('field_atv_total', $spreader_subtotal);

            // Assuming $hourlyRate is the charge per hour.
            if ($totalTime > 0) {
                $labor_subtotal = $hourlyRate * $totalTime;
            }
            $entity->set('field_labor_total', $labor_subtotal);

        }
        
        // Continue on with Updating the Work Order Entity.
        
        // Set Total Fertilizer Pounds
        if ($poundsTotalUsed > 0) {
            $entity->set('field_total_pounds', $poundsTotalUsed);
        }

        // Set Total Fertilizer Costs
        if ($fertilizerTotalCosts > 0) {
            $entity->set('field_fertilizer_total', $fertilizerTotalCosts);
        }

        // Set Total Fertilizing Chemical Costs
        if ($fertilizerChemicalTotalCosts > 0) {
            $entity->set('field_material_chemical_total', $fertilizerChemicalTotalCosts);
        }

        // Enter Fertilizing Charge
        if ($fertilizingRate > 0) {
            $grand_total += $fertilizingRate;
        }

        // Office Adjust Total as needed for invoicing
        $billingAdjustment = $entity->get('field_billing_adjustment')->value;
        $grand_total += $billingAdjustment;

        // Future calculations can modify $grand_total as needed.
        // Set 'field_total' with the final $grand_total value.
        if ($grand_total > 0) {
            $entity->set('field_wo_total', $grand_total);
        }
    }
}

/**
 * Implements hook_entity_insert() for work_order entities.
 */
function wo_fertilizing_entity_insert(EntityInterface $entity) {
    // Check if it's the right entity type and bundle.
    if ($entity->getEntityTypeId() === 'work_order' && $entity->bundle() === 'fertilizing') {
      // Perform actions specific to when a new work order of the 'fertilizing' bundle is created.
      _wo_fertilizing_handle_work_order($entity, 'insert');
    }
  }
  
/**
 * Implements hook_entity_update() for work_order entities.
 */
function wo_fertilizing_entity_update(EntityInterface $entity) {
    // Check if it's the right entity type and bundle.
    if ($entity->getEntityTypeId() === 'work_order' && $entity->bundle() === 'fertilizing') {
        // Perform actions specific to when a work order of the 'fertilizing' bundle is updated.
        _wo_fertilizing_handle_work_order($entity, 'update');
    }
}

/**
 * A helper function to process work orders on insert or update.
 * 
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   The entity being inserted or updated.
 * @param string $operation
 *   The operation being performed ('insert' or 'update').
 */
function _wo_fertilizing_handle_work_order(EntityInterface $entity, $operation) {
    // Shared logic to handle both insert and update operations.
    // You can use the $operation parameter if you need to distinguish between inserts and updates.

    // Check if the Work Order is marked as 'Complete'.
    $statusTermId = $entity->get('field_status')->target_id ?? 0;
    
    if ($statusTermId != 1097) {
        //If the Work Order is not 'Complete', exit the function early to avoid performing further calculations.
        return;
    }        
    
    // Get Work Order Complete Info
    $workOrderId = $entity->id();

    $poundsUsed = 0;
    $currentSeasonValue = '';
    $signOffDateFormated = null;
    $signOffBy = 1;
    
    // Load 'wo_complete_info' entities by '$workOrderId'.
    $woSignOffInfoEntities = \Drupal::entityTypeManager()->getStorage('wo_complete_info')->loadByProperties([
        'field_work_order' => $workOrderId,
        'type' => 'fertilizing_crew',
    ]);
    $woSignOffInfo = reset($woSignOffInfoEntities);

    if (!empty($woSignOffInfo)) {
        // Get needed Info for Property Fertilizing Info
        $woSignOffInfoTimestamp = $woSignOffInfo->get('field_date_completed')->value;
        $signOffDate = DrupalDateTime::createFromTimestamp($woSignOffInfoTimestamp);
        $signOffDate->setTimezone(new \DateTimeZone('UTC'));
        $signOffDateFormated = $signOffDate->format('Y-m-d\TH:i:s');
        $signOffBy = $woSignOffInfo->get('field_signed_off_by')->target_id;
        $poundsUsed = get_pounds_used_for_fertilizing($workOrderId);

    // Get Property ID from Work Order
    $propertyId = $entity->get('field_property')->target_id ?? null;

    // Load 'property_spraying_info' entities by 'field_property'.
    $propertySprayingInfo = \Drupal::entityTypeManager()->getStorage('property_fertilizing_info')->loadByProperties([
        'field_property' => $propertyId,
        'type' => 'lawn_fertilizing_information',
    ]);
    
        // Set Property Fertilizing Info - Last Applied Information.
        if (!empty($propertySprayingInfo)) {
            // Get the first entity (assuming there's only one) from the loaded entities.
            $sprayingInfoEntity = reset($propertySprayingInfo);
            
            if ($sprayingInfoEntity) {
                $sprayingInfoEntity->set('field_fertilizer_lbs_applied', $poundsUsed);
                $sprayingInfoEntity->set('field_fertilized_last', $signOffDateFormated);
                $sprayingInfoEntity->set('field_fertilized_last_by', $signOffBy);
            }
            // Save the updated Property Fertilizing Info entity.
            $sprayingInfoEntity->save();
        }
    }
}

/**
 * Retrieves the Total pounds used for Fertilizing wo_chemicals_used entities.
 *
 * @param int $workOrderId
 *   The work order entity ID.
 *
 * @return int
 *   The total pounds used of Fertilizers.
 */
function get_pounds_used_for_fertilizing($workOrderId) {

    if (!is_numeric($workOrderId) || $workOrderId < 1 || !\Drupal::entityTypeManager()->getStorage('work_order')->load($workOrderId)) {
        return 0;
    }

    $poundsUsed = 0;

    // Load wo_chemicals_used entities that reference the given work order.
    $fertilizerUsedEntities = \Drupal::entityTypeManager()->getStorage('wo_chemicals_used')->loadByProperties([
        'field_work_order' => $workOrderId,
        'type' => 'fertilizers',
    ]);

    if (!empty($fertilizerUsedEntities)) {
        foreach ($fertilizerUsedEntities as $entity) {
            // Sum the pounds used.
            $pounds = $entity->get('field_fertilizer_lbs_applied')->value; // Adjust 'field_total_gallons_applied' to your actual field name.
            $poundsUsed += $pounds;
        }
    }

    return $poundsUsed;
}

/**
 * Retrieves the Total Costs of Fertilizers within wo_chemicals_used entities.
 *
 * @param int $workOrderId
 *   The work order entity ID.
 *
 * @return int
 *   The total costs value for Fertilizers.
 */
function get_costs_for_fertilizing($workOrderId) {

    if (!is_numeric($workOrderId) || $workOrderId < 1 || !\Drupal::entityTypeManager()->getStorage('work_order')->load($workOrderId)) {
        return 0;
    }

    $fertilizerCost = 0;

    // Load wo_chemicals_used entities that reference the given work order.
    $fertilizerCostEntities = \Drupal::entityTypeManager()->getStorage('wo_chemicals_used')->loadByProperties([
        'field_work_order' => $workOrderId,
        'type' => 'fertilizers',
    ]);

    if (!empty($fertilizerCostEntities)) {
        foreach ($fertilizerCostEntities as $entity) {
            // Sum the pounds used.
            $costs = $entity->get('field_fertilizer_cost')->value; // Adjust 'field_total_gallons_applied' to your actual field name.
            $fertilizerCost += $costs;
        }
    }

    return $fertilizerCost;
}

/**
 * Retrieves the Total Costs of Fertilizers within wo_chemicals_used entities.
 *
 * @param int $workOrderId
 *   The work order entity ID.
 *
 * @return int
 *   The total costs value for Fertilizers.
 */
function get_costs_for_fertilizing_chemicals($workOrderId) {

    if (!is_numeric($workOrderId) || $workOrderId < 1 || !\Drupal::entityTypeManager()->getStorage('work_order')->load($workOrderId)) {
        return 0;
    }

    $fertilizerChemicalCost = 0;

    // Load wo_chemicals_used entities that reference the given work order.
    $fertilizerChemicalCostEntities = \Drupal::entityTypeManager()->getStorage('wo_chemicals_used')->loadByProperties([
        'field_work_order' => $workOrderId,
        'type' => 'fertilizing_chemicals',
    ]);

    if (!empty($fertilizerChemicalCostEntities)) {
        foreach ($fertilizerChemicalCostEntities as $entity) {
            // Sum the pounds used.
            $costs = $entity->get('field_subtotal')->value; // Adjust 'field_total_gallons_applied' to your actual field name.
            $fertilizerChemicalCost += $costs;
        }
    }

    return $fertilizerChemicalCost;
}

/**
 * Retrieves the Hours clocked in for Fertilizing Trees and Shrubs from related wo_time_clock entities.
 *
 * @param int $workOrderId
 *   The work order entity ID.
 *
 * @return int
 *   The total hours for Fertilizing Trees and Shrubs Work Order.
 */
function get_hours_for_fertilizing($workOrderId) {

    if (!is_numeric($workOrderId) || $workOrderId < 1 || !\Drupal::entityTypeManager()->getStorage('work_order')->load($workOrderId)) {
        return 0;
    }

    $hoursSpent = 0;

    // Load wo_time_clock entities that reference the given work order.
    $woTimeClockEntities = \Drupal::entityTypeManager()->getStorage('wo_time_clock')->loadByProperties([
        'field_work_order' => $workOrderId,
    ]);

    foreach ($woTimeClockEntities as $entity) {
        // Check if the entity is part of the 'Fertilizing Trees and Shrubs' bundle.
        if ($entity->bundle() === 'entry') {
            // Sum the hours.
            $hours = $entity->get('field_total_time')->value; // Adjust 'field_total_time' that is a Number(decimal).
            $hoursSpent += $hours;
        }
    }

    return $hoursSpent;
}

function get_men_for_fertilizing($workOrderId) {

    if (!is_numeric($workOrderId) || $workOrderId < 1 || !\Drupal::entityTypeManager()->getStorage('work_order')->load($workOrderId)) {
        return 0;
    }

    // Use an Entity Query to find the latest 'wo_complete_info' entity for the given work order.
    $query = \Drupal::entityQuery('wo_complete_info')
        ->accessCheck(FALSE) // Enforce access checks
        ->condition('field_work_order', $workOrderId)
        ->sort('field_date_completed', 'DESC') // Adjust 'field_completed_date' to your actual date field name.
        ->range(0, 1); // Limit to the latest entity.

    $result = $query->execute();

    if (empty($result)) {
        return 0; // Return early if no entities are found.
    }

    $latestEntityId = reset($result);
    $latestEntity = \Drupal::entityTypeManager()->getStorage('wo_complete_info')->load($latestEntityId);

    // Assuming 'field_those_on_crew' is a list of 'uid' values.
    $totalMen = $latestEntity->get('field_those_on_crew')->count();// Count the list of them on site.
    
    return $totalMen;
}

function get_trucks_for_fertilizing($workOrderId) {

    if (!is_numeric($workOrderId) || $workOrderId < 1 || !\Drupal::entityTypeManager()->getStorage('work_order')->load($workOrderId)) {
        return 0;
    }

    // Use an Entity Query to find the latest 'wo_complete_info' entity for the given work order.
    $query = \Drupal::entityQuery('wo_complete_info')
        ->accessCheck(FALSE) // Enforce access checks
        ->condition('field_work_order', $workOrderId)
        ->sort('field_date_completed', 'DESC') // Adjust 'field_completed_date' to your actual date field name.
        ->range(0, 1); // Limit to the latest entity.

    $result = $query->execute();

    if (empty($result)) {
        return 0; // Return early if no entities are found.
    }

    $latestEntityId = reset($result);
    $latestEntity = \Drupal::entityTypeManager()->getStorage('wo_complete_info')->load($latestEntityId);

    // Assuming 'field_those_on_crew' is a list of 'uid' values.
    $trucksSelected = $latestEntity->get('field_how_many_trucks_taken')->value;// The select list is 1 number off
    $totalTrucks = $trucksSelected + 1;

    return $totalTrucks;
}