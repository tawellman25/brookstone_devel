<?php

/**
 * @file
 * Module file for the WO Material List Management.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Url;
use Symfony\Component\HttpFoundation\RedirectResponse;

/**
 * Implements hook_entity_presave().
 */
function wo_material_list_management_entity_presave(EntityInterface $entity) {
  if ($entity->getEntityTypeId() === 'wo_material_list_item') {
    // Set field_list_id for new items if not already set.
    if ($entity->hasField('field_list_id') && !$entity->get('field_list_id')->target_id) {
      $parent_list = \Drupal::routeMatch()->getParameter('wo_material_list');
      if ($parent_list) {
        $entity->set('field_list_id', ['target_id' => $parent_list->id()]);
      }
    }

    // Skip recalculations for cloned items.
    if (property_exists($entity, 'bypass_recalculation') && $entity->bypass_recalculation) {
      \Drupal::logger('wo_material_list_management')->notice('Recalculation bypassed for cloned item ID: @id', ['@id' => $entity->id()]);
      return;
    }

    // Perform recalculations for manually entered items.
    if ($entity->hasField('field_material_type') && $entity->get('field_material_type')->value === 'stocked_item') {
      if ($entity->hasField('field_parts_used') && !$entity->get('field_parts_used')->isEmpty()) {
        $parts_used = $entity->get('field_parts_used')->first()->entity;

        if ($parts_used && $parts_used->hasField('field_cost_integer')) {
          $cost = $parts_used->get('field_cost_integer')->value;
          if ($entity->hasField('field_material_cost') && $entity->get('field_material_cost')->isEmpty()) {
            $entity->set('field_material_cost', $cost);
          }
        }
      }
    }

    // Calculate subtotal and markup if applicable.
    if ($entity->hasField('field_material_cost') && $entity->hasField('field_quantity')) {
      $material_cost = $entity->get('field_material_cost')->value;
      $quantity = $entity->get('field_quantity')->value;

      if (!empty($material_cost) && !empty($quantity)) {
        $subtotal = $material_cost * $quantity;
        if ($entity->hasField('field_subtotal')) {
          $entity->set('field_subtotal', $subtotal);
        }

        // Add markup calculation.
        $config_pages = \Drupal::service('config_pages.loader');
        $markup_array = $config_pages->getValue('business_setting', 'field_markup');
        $markup_value = isset($markup_array[0]['value']) ? (float) $markup_array[0]['value'] : 1.0;

        if (!empty($markup_value) && is_numeric($markup_value)) {
          $subtotal_with_markup = $subtotal * $markup_value;
          if ($entity->hasField('field_subtotal_w_markup')) {
            $entity->set('field_subtotal_w_markup', $subtotal_with_markup);
          }
        }
      }
    }
  }
}

/**
 * Implements hook_entity_view().
 */
function wo_material_list_management_entity_view(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display, $view_mode) {
  if ($entity->getEntityTypeId() === 'wo_material_list' && $view_mode == 'full') {
    \Drupal::logger('wo_material_list_management')->notice('Adding form for entity ID: @id', ['@id' => $entity->id()]);

    $build['material_list_management'] = \Drupal::formBuilder()->getForm('Drupal\wo_material_list_management\Form\MaterialListManagementForm', $entity);
  }
}
