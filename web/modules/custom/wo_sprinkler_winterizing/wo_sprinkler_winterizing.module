<?php

use Drupal\Core\Entity\EntityInterface;
use Drupal\config_pages\ConfigPagesLoaderInterface;
use Drupal\eck\EckEntityInterface;
use Drupal\views\Views;

/**
 * Implements hook_entity_presave().
 */
function wo_sprinkler_winterizing_entity_presave(EntityInterface $entity) {
    // Initialize $grand_total at the start.
    $grand_total = 0;
    $totalTrip = 0;
    $labor_subtotal = 0;
    $propertyTotalZones = 0;
    $zoneTotal = 0;

    // Check if it's a Work Order entity of the 'Sprinkler Repair' bundle.
    if ($entity->getEntityTypeId() === 'work_order' && $entity->bundle() === 'sprinkler_winterizing') {

        // Check if the Work Order is marked as 'Complete'.
        $statusTermId = $entity->get('field_status')->target_id ?? 0;
        if ($statusTermId != 1097) {
            //If the Work Order is not 'Complete', exit the function early to avoid performing further calculations.
            return;
        }

        $workOrderId = $entity->id();
        $propertyId = $entity->get('field_property')->target_id ?? null;

        // The Work Order is 'Complete'; you can now proceed with further calculations.
        // Initialize variables to ensure they're defined before use.

        $config_pages_loader = \Drupal::service('config_pages.loader');
        $business_settings = $config_pages_loader->load('business_setting');
        
        if ($business_settings) {
            // Fetch the configured minimums and fees.
            $minAllottedTime = $business_settings->get('field_hour_billing_increment')->value; // Assume this is in minutes for the calculation.
            $hourlyRate = $business_settings->get('field_sprinkler_technician_rate')->value;
            $hourlyBillingIncrement = $business_settings->get('field_hour_billing_increment')->value;
            $winterizingBaseRate = $business_settings->get('field_winterizing_base_fee')->value;
            $winterizingZoneLimit = $business_settings->get('field_winterizing_zone_limit')->value;
            $winterizingZoneFee = $business_settings->get('field_winterizing_extra_zone_fee')->value;
            $winterizingPumpFee = $business_settings->get('field_winterizing_pump_fee')->value;
            
            $timeSpent = get_hours_for_sprinkler_winterizing($entity->id()); // Total hours of all man that clocked in.
            $totalZones = fetch_property_sprinkler_winterize_zones_data($propertyId);
            $propertySystemTypeTotal = calculate_property_sprinkler_system_winterize_type_total($propertyId);

            // Calculate costs.  These are included above any Startup rate.
            // Material Costs
            $material_subtotal = get_total_sprinkler_winterizing_material_list_price($workOrderId); // Total materials with markup of all material lists.
            $entity->set('field_material_chemical_total', $material_subtotal);

            // Calculate the Labor Rates for Repairs only if material is greater than 0.
            if ($material_subtotal > 0 && $material_subtotal < 25) {
                $labor_subtotal = 35;
            } elseif ($material_subtotal > 25 && $timeSpent <= 1) {
                $labor_subtotal = 35;
            } elseif ($material_subtotal > 25 && $timeSpent > 1) {
                $totalTime = $timeSpent - 1;
                $totalMinutes = $totalTime * 60;
                if ($totalMinutes <= 15) {
                    $labor_subtotal = 35;
                } else {
                    $totalTimeIncrements = ceil($totalMinutes / $hourlyBillingIncrement);
                    $hourlyIncrement = $hourlyBillingIncrement / 60;
                    $hourlyRateIncrement = $hourlyRate * $hourlyIncrement;
                    $labor_subtotal = $hourlyRateIncrement * $totalTimeIncrements;
                }
            }

            // Calculate the Task Rate based of of Zones and System Type.
            if ($totalZones > $winterizingZoneLimit) {
                $billableZones = $totalZones - $winterizingZoneLimit;
                $zoneTotal = $billableZones * $winterizingZoneFee;
            }

            $systemTypeTotal = $propertySystemTypeTotal;

            // Set values of the Time and Labor fields.
            $entity->set('field_total_time', $timeSpent);
            $entity->set('field_zone_total', $totalZones);
            $entity->set('field_zone_charge', $zoneTotal);
            $entity->set('field_labor_total', $labor_subtotal);
            $entity->set('field_task_rate', $systemTypeTotal);
        }


        // Labor from above
        // Make sure Labor is a positive number and add to grand total.
        if ($labor_subtotal > 0) {
            $grand_total += $labor_subtotal;
        }
        
        // Make sure System Type Total is a positive number and add to grand total.
        if ($systemTypeTotal > 0) {
            $grand_total += $systemTypeTotal;
        }

        // Make sure Zone Carge Total is a positive number and add to grand total.
        if ($zoneTotal > 0) {
            $grand_total += $zoneTotal;
        }

        // Make sure materials is a positive number and add to grand total.
        if ($material_subtotal > 0) {
            $grand_total += $material_subtotal;
        }

        // Trip Fee from above
        // Make sure Trip Fee is a positive number and add to grand total.
        //if ($totalTrip > 0) {
        //    $grand_total += $totalTrip;
        //}
        
        //Rental Fees
        // Now, add the Equipment Rental Fees from related 'wo_rental_equipment' entities.
        $rental_fee_total = get_sprinkler_winterizing_total_rental_fees($workOrderId);
  
        // Make sure Rental is a positive number and add to grand total.
        if ($rental_fee_total > 0) {
            // Set the rental fee total on the entity regardless of grand total.
            $entity->set('field_rental_total', $rental_fee_total);
            $grand_total += $rental_fee_total;
        }

        // Office Adjust Total as needed for invoicing
        $billingAdjustment = $entity->get('field_billing_adjustment')->value;
        $grand_total += $billingAdjustment;

        // Future calculations can modify $grand_total as needed.
        // Set 'field_total' with the final $grand_total value.
        if ($grand_total > 0) {
            $entity->set('field_wo_total', $grand_total);
        }
    }
}

/**
 * Fetches data from the property_sprinkler_info entity for a given property ID
 * and totals the 'field_total_zones' from all referenced property_sprinkler_system entities.
 *
 * @param int $propertyId
 *   The property ID to search the property_sprinkler_info entities for.
 *
 * @return array
 *   An associative array containing the data fetched from the property_sprinkler_info entity,
 *   including the total of all 'field_total_zones' values.
 */
function fetch_property_sprinkler_winterize_zones_data($propertyId) {
    $totalZones = 0; // Initialize total zones counter as an integer.

    if (empty($propertyId) || !is_numeric($propertyId)) {
        return $totalZones; // Return early if the propertyId is invalid.
    }

    // Load the property_sprinkler_info entities that reference the property ID.
    $query = \Drupal::entityQuery('property_sprinkler_info')
        ->condition('field_property', $propertyId)
        ->accessCheck(FALSE); // Use FALSE to bypass access checks, or TRUE to enforce them.
    $entityIds = $query->execute();

    if (!empty($entityIds)) {
        $firstEntityId = reset($entityIds);
        $propertySprinklerInfoEntity = \Drupal::entityTypeManager()->getStorage('property_sprinkler_info')->load($firstEntityId);

        if ($propertySprinklerInfoEntity) {
            // Assuming 'systems' is the field name of the entity reference field in property_sprinkler_info.
            $systemIds = $propertySprinklerInfoEntity->get('field_systems')->getValue();
            
            foreach ($systemIds as $systemId) {
                $systemEntity = \Drupal::entityTypeManager()->getStorage('property_sprinkler_system')->load($systemId['target_id']);
                if ($systemEntity) {
                    // Retrieve the value of 'field_total_zones' and add it to the total.
                    $zones = $systemEntity->get('field_total_zones')->value;
                    $totalZones += (int) $zones; // Ensure conversion to integer before adding.
                }
            }
        }
    }

    return $totalZones; // Return the total zones as an integer.
}


/**
 * Calculates the total cost based on specific system types associated with a property.
 *
 * @param int $propertyId
 *   The property ID to search the property_sprinkler_info entities for.
 *
 * @return int
 *   The total cost calculated based on the system type IDs.
 */

function calculate_property_sprinkler_system_winterize_type_total($propertyId) {
    $totalCost = 0; // Initialize total cost

    // Load the business settings config page.
    /** @var ConfigPagesLoaderInterface $config_pages_loader */
    $config_pages_loader = \Drupal::service('config_pages.loader');
    $business_settings = $config_pages_loader->load('business_setting');
    
    if ($business_settings) {
        $winterizingBaseRate = $business_settings->get('field_winterizing_base_fee')->value;
        $winterizingPumpFee = $business_settings->get('field_winterizing_pump_fee')->value;
    } else {
        // Handle the case where business settings are not found. 
        // For example, you could set default values or log an error.
        $winterizingBaseRate = 90;
        $winterizingPumpFee = 25;
    }

    if (empty($propertyId) || !is_numeric($propertyId)) {
        return $totalCost; // Return early if the propertyId is invalid.
    }

    $query = \Drupal::entityQuery('property_sprinkler_info')
        ->condition('field_property', $propertyId)
        ->accessCheck(FALSE);
    $entityIds = $query->execute();

    if (!empty($entityIds)) {
        $firstEntityId = reset($entityIds);
        $propertySprinklerInfoEntity = \Drupal::entityTypeManager()->getStorage('property_sprinkler_info')->load($firstEntityId);

        if ($propertySprinklerInfoEntity) {
            $systemIds = $propertySprinklerInfoEntity->get('field_systems')->getValue();
            
            foreach ($systemIds as $systemId) {
                $systemEntity = \Drupal::entityTypeManager()->getStorage('property_sprinkler_system')->load($systemId['target_id']);
                if ($systemEntity) {
                    $targetId = $systemEntity->get('field_system_type')->target_id;
                    if ($targetId !== NULL) {
                        // Calculate total cost based on targetId
                        switch ($targetId) {
                            case 13:
                                $totalCost += $winterizingBaseRate;
                                break;
                            case 15:
                            case 16:
                            case 30742:
                                $totalCost += ($winterizingBaseRate + $winterizingPumpFee);
                                break;
                        }
                    }
                }
            }
        }
    }

    return $totalCost;
}


/**
 * Calculates the total Materials for a given Work Order.
 */
function get_total_sprinkler_winterizing_material_list_price($workOrderId) {
    $database = \Drupal::database();

    // Start by selecting from the table that contains subtotal values.
    $query = $database->select('wo_material_list_item__field_subtotal_w_markup', 'subtotal');
    
    // Join to link the subtotal values to their respective material list items.
    $query->join('wo_material_list_item', 'items', 'subtotal.entity_id = items.id');
    
    // Join to link each material list item to its material list via the reference field.
    // Adjust the join condition based on your actual data model.
    $query->join('wo_material_list_item__field_list_id', 'list_id', 'items.id = list_id.entity_id');
    
    // Then, join to the material list to work order reference table.
    // This assumes there's a direct relationship table or field connecting material lists to work orders.
    $query->join('wo_material_list__field_work_order', 'work_order', 'list_id.field_list_id_target_id = work_order.entity_id');
    
    // Filter by the work order ID.
    $query->condition('work_order.field_work_order_target_id', $workOrderId);
    
    // Specify the field to sum for the total.
    $query->addExpression('SUM(subtotal.field_subtotal_w_markup_value)', 'total_subtotal_w_markup');
    
    // Execute the query and fetch the result.
    $result = $query->execute()->fetchField();

    return $result ? $result : 0;
}

/**
 * Calculates the total Rented Equipment fees for a given Work Order.
 */
function get_sprinkler_winterizing_total_rental_fees($workOrderId) {
    $database = \Drupal::database();
    
    // Query the dedicated field storage table for 'field_receipt_total_cost'.
    $query = $database->select('wo_rental_equipment__field_receipt_total_cost', 'rental_fees');
    
    // Join the entity base table to access the Work Order reference.
    // This assumes 'field_rented_for' is the correct entity reference field name.
    $query->join('wo_rental_equipment__field_rented_for', 'work_order', 'rental_fees.entity_id = work_order.entity_id');
    
    // Filter by the Work Order ID.
    $query->condition('work_order.field_rented_for_target_id', $workOrderId);
    
    // Sum the rental fee values.
    $query->addExpression('SUM(rental_fees.field_receipt_total_cost_value)', 'total_rental_fee');
    
    // Execute the query and fetch the result.
    $result = $query->execute()->fetchField();
    
    return $result ? $result : 0;
}

/**
 * Retrieves the Hours clocked in for sprinkler_winterizing from related wo_time_clock entities.
 *
 * @param int $workOrderId
 *   The work order entity ID.
 *
 * @return int
 *   The total hours for sprinkler_winterizing Work Order.
 */
function get_hours_for_sprinkler_winterizing($workOrderId) {

    if (!is_numeric($workOrderId) || $workOrderId < 1 || !\Drupal::entityTypeManager()->getStorage('work_order')->load($workOrderId)) {
        return 0;
    }

    $hoursSpent = 0;

    // Load wo_time_clock entities that reference the given work order.
    $woTimeClockEntities = \Drupal::entityTypeManager()->getStorage('wo_time_clock')->loadByProperties([
        'field_work_order' => $workOrderId,
    ]);

    foreach ($woTimeClockEntities as $entity) {
        // Check if the entity is part of the 'pre-emergent' bundle.
        if ($entity->bundle() === 'entry') {
            // Sum the gallons used.
            $hours = $entity->get('field_total_time')->value; // Adjust 'field_total_time' that is a Number(decimal).
            $hoursSpent += $hours;
        }
    }

    return $hoursSpent;
}
